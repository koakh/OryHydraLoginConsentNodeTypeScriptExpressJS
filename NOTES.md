# NOTES

## BootStrap Latest Project

```shell
$ git clone https://github.com/ory/hydra-login-consent-node.git
$ cd hydra-login-consent-node
$ npm i
```

change `"start": "ts-node-dev --watch public,views --respawn src/app.ts",` to `"start": "PORT=3001 HYDRA_ADMIN_URL=http://localhost:4445 ts-node-dev --watch public,views --respawn src/app.ts",`

```shell
$ npm start
```

## Other Notes

```shell
$ cd /mnt/storage/Development/@OAuth2/Ory/Hydra/OryHydraIntegratingOAuth20WithARustWebService/hydra-auth-example-rs
$ docker-compose up -d
$ curl -X POST \
	http://localhost:4445/clients \
	-H 'Content-Type: application/json' \
	-d '{
 "client_id": "my-implicit-client",
 "grant_types": ["implicit"],
 "response_types": ["token"],
 "redirect_uris": ["http://localhost:3000/"],
 "token_endpoint_auth_method": "client_secret_post"
}'

# $ curl -X POST \
#   http://localhost:4445/clients \
#   -H 'Content-Type: application/json' \
#   -d '{
#  "client_id": "my-client-credentials-client",
#  "grant_types": ["client_credentials"],
#  "response_types": ["token"],
#  "scope": "offline openid offline_access email phone profile address",
#  "redirect_uris": ["http://localhost:3000/"],
#  "token_endpoint_auth_method": "client_secret_post"
# }'

$ curl -s -X GET http://localhost:4445/clients/my-implicit-client | jq
# $ curl -s -X GET http://localhost:4445/clients/my-client-credentials-client | jq
```

To start the flow, navigate to [Authorization Initialization link](localhost:4444/oauth2/auth?client_id=my-implicit-client&response_type=token&scope=offline&state=blahblahblah) which is usually generated by an OAuth2 client or library.

To start the flow, navigate to [Authorization Initialization link](localhost:4444/oauth2/auth?client_id=my-client-credentials-client&response_type=token&scope=offline&state=blahblahblah) which is usually generated by an OAuth2 client or library.

## Add Permissions and Roles to JWT

add to `src/routes/consent.ts`

```typescript
// The session allows us to set session data for id and access tokens
let session: ConsentRequestSession = {
	// This data will be available when introspecting the token. Try to avoid sensitive information here,
	// unless you limit who can introspect tokens.
	access_token: {
	// foo: 'bar'
	},

	// This data will be available in the ID token.
	id_token: {
		// baz: 'bar'
		permissions: ['create:items', 'update:items', 'delete:items'],
		roles: ['ROLE_USER', 'ROLE_ADMIN'],
		metadata: {
			someProp: 'someValue',
			// body: req.body
			// outputs in jwt bellow
			// body": {
			//   "_csrf": "mQH1q34K-hFRUnTeHN4OC_YVH4nF9TiZL_cs",
			//   "challenge": "bd101c63d64a4c9f9a0c2f6b7ddbee59",
			//   "grant_scope": [
			//     "openid",
			//     "profile",
			//     "email",
			//     "offline_access"
			//   ],
			//   "submit": "Allow access"
	}
	}
}
```

now logout and login and inspect `idToken` jwt

```json
"metadata": {
    "someProp": "someValue"
  },
  "permissions": [
    "create:items",
    "update:items",
    "delete:items"
  ],
	...
  "roles": [
    "ROLE_USER",
    "ROLE_ADMIN"
  ],
```

### Convert project from PUG to EJS Template Engine

- [X] added eslint config
		[How to use ESLint with TypeScript](https://khalilstemmler.com/blogs/typescript/eslint-for-typescript/)
		npm install --save-dev eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin
- [X] bump all package.json dependencies, only leave "@oryd/hydra-client": "1.9.0-alpha.2" because of new refactor `snake_case` to `pascalCase` problems
- [X] move all @types to devDependencies
- [X] found 0 vulnerabilities
- [X] removed `url-join` dependency gives problems with  **dynamic imports**, now use a minimal axios helper function at `src/helpers.ts`
- [X] added `@types/node`
- [ ] exchange pug with ejs
	https://blog.logrocket.com/how-to-use-ejs-template-node-js-application/
- [ ] install tailwind css
	https://tailwindcss.com/docs/installation
	https://tailwindcomponents.com/component/responsive-login-page
	https://tailwind-elements.com/docs/standard/components/login-form/
- [ ] 